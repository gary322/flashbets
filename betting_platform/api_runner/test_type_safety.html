<!DOCTYPE html>
<html>
<head>
    <title>Type Safety Test Suite</title>
    <script src="../programs/betting_platform_native/ui_demo/safe-numbers.js"></script>
    <script src="../programs/betting_platform_native/ui_demo/types.js"></script>
</head>
<body>
    <h1>Type Safety Test Suite</h1>
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        let passCount = 0;
        let failCount = 0;

        function test(name, fn) {
            try {
                fn();
                results.innerHTML += `<p style="color: green">✅ ${name}</p>`;
                passCount++;
            } catch (error) {
                results.innerHTML += `<p style="color: red">❌ ${name}: ${error.message}</p>`;
                failCount++;
            }
        }

        function assert(condition, message) {
            if (!condition) {
                throw new Error(message);
            }
        }

        // Test SafeNumbers
        results.innerHTML += '<h2>SafeNumbers Tests</h2>';

        test('Parse BigInt from string', () => {
            const result = SafeNumbers.parseBigInt('340282366920938463463374607431768211455');
            assert(typeof result === 'bigint', 'Should return BigInt');
            assert(result === 340282366920938463463374607431768211455n, 'Should parse correctly');
        });

        test('Parse BigInt from number', () => {
            const result = SafeNumbers.parseBigInt(123456);
            assert(result === 123456n, 'Should convert number to BigInt');
        });

        test('Format amount with decimals', () => {
            const result = SafeNumbers.formatAmount('1000000000', 9); // 1 SOL
            assert(result === '1', 'Should format 1 SOL correctly');
            
            const result2 = SafeNumbers.formatAmount('1500000000', 9); // 1.5 SOL
            assert(result2 === '1.5', 'Should format 1.5 SOL correctly');
        });

        test('Parse decimal amount', () => {
            const result = SafeNumbers.parseAmount('1.5', 9);
            assert(result === 1500000000n, 'Should parse 1.5 SOL to lamports');
        });

        test('Compare BigInt values', () => {
            assert(SafeNumbers.compare('100', '200') === -1, 'Should return -1 for less than');
            assert(SafeNumbers.compare('200', '100') === 1, 'Should return 1 for greater than');
            assert(SafeNumbers.compare('100', '100') === 0, 'Should return 0 for equal');
        });

        test('Calculate percentage', () => {
            const result = SafeNumbers.percentage('25', '100', 2);
            assert(result === '25.00', 'Should calculate 25%');
        });

        test('Create market ID', () => {
            const id = SafeNumbers.createMarketId('123456789012345678901234567890');
            assert(id.string === '123456789012345678901234567890', 'Should store string');
            assert(id.toBigInt() === 123456789012345678901234567890n, 'Should convert to BigInt');
        });

        // Test TypeValidator
        results.innerHTML += '<h2>TypeValidator Tests</h2>';

        test('Validate market type', () => {
            const validMarket = {
                id: '123456',
                title: 'Test Market',
                outcomes: ['Yes', 'No'],
                total_liquidity: '1000000',
                total_volume: '5000000'
            };
            
            const result = TypeValidator.validate(validMarket, MarketType);
            assert(result.isValid === true, 'Should validate valid market');
        });

        test('Detect missing required field', () => {
            const invalidMarket = {
                title: 'Test Market'
                // Missing id
            };
            
            const result = TypeValidator.validate(invalidMarket, MarketType);
            assert(result.isValid === false, 'Should detect missing field');
            assert(result.errors.length > 0, 'Should have errors');
        });

        test('Validate optional fields', () => {
            const market = {
                id: '123',
                title: 'Test',
                outcomes: [],
                total_liquidity: '0',
                total_volume: '0'
                // description is optional
            };
            
            const result = TypeValidator.validate(market, MarketType);
            assert(result.isValid === true, 'Should allow missing optional fields');
        });

        test('Create validated market', () => {
            const rawData = {
                id: '123456789012345678901234567890',
                title: 'Test Market',
                outcomes: ['Yes', 'No'],
                total_liquidity: '1000000000',
                total_volume: '5000000000'
            };
            
            const market = TypeValidator.createMarket(rawData);
            assert(market !== null, 'Should create market');
            assert(market.id.toBigInt() === 123456789012345678901234567890n, 'Should handle ID as BigInt');
            assert(market.total_liquidity === 1000000000n, 'Should parse liquidity');
        });

        test('Validate trade request', () => {
            const validRequest = {
                market_id: '123456',
                amount: '1000000000',
                leverage: 5,
                side: 'long',
                wallet: 'ABC123...'
            };
            
            const request = TypeValidator.createTradeRequest(validRequest);
            assert(request !== null, 'Should create valid request');
        });

        test('Reject invalid leverage', () => {
            const invalidRequest = {
                market_id: '123456',
                amount: '1000000000',
                leverage: 150, // Too high
                side: 'long',
                wallet: 'ABC123...'
            };
            
            const request = TypeValidator.createTradeRequest(invalidRequest);
            assert(request === null, 'Should reject invalid leverage');
        });

        // Test edge cases
        results.innerHTML += '<h2>Edge Case Tests</h2>';

        test('Handle max u128 value', () => {
            const maxU128 = '340282366920938463463374607431768211455';
            const bigInt = SafeNumbers.parseBigInt(maxU128);
            assert(bigInt.toString() === maxU128, 'Should handle max u128');
        });

        test('Handle max u64 value', () => {
            const maxU64 = '18446744073709551615';
            const bigInt = SafeNumbers.parseBigInt(maxU64);
            assert(bigInt.toString() === maxU64, 'Should handle max u64');
        });

        test('Detect unsafe JavaScript number', () => {
            const unsafeNumber = 9007199254740993; // MAX_SAFE_INTEGER + 2
            // This should log a warning
            SafeNumbers.parseBigInt(unsafeNumber);
            assert(true, 'Should handle but warn about unsafe numbers');
        });

        // Summary
        results.innerHTML += '<h2>Summary</h2>';
        results.innerHTML += `<p>Tests passed: ${passCount}</p>`;
        results.innerHTML += `<p>Tests failed: ${failCount}</p>`;
        results.innerHTML += `<p>Total: ${passCount + failCount}</p>`;
    </script>
</body>
</html>